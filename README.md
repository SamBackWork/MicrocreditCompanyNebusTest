
# Organization API

## Описание

REST API для управления справочником организаций, зданий и видов деятельности. Приложение предоставляет функциональность для создания, чтения и поиска данных об организациях, их местоположении (зданиях) и связанных видах деятельности. API поддерживает фильтрацию организаций по географическим координатам (радиус и прямоугольник), поиск по имени, а также иерархическую структуру видов деятельности.

### Основные возможности:
- **Организации**:
  - Создание и получение информации об организациях.
  - Привязка организаций к зданиям, телефонам и видам деятельности.
  - Поиск организаций по зданию, виду деятельности, имени или географическому положению.
- **Здания**:
  - Управление данными о зданиях (адрес, широта, долгота).
  - Получение списка организаций в конкретном здании.
- **Виды деятельности**:
  - Иерархическая структура с поддержкой до 3 уровней вложенности.
  - Создание и получение видов деятельности с их дочерними элементами.
  - Поиск организаций по виду деятельности (с опциональной рекурсией по дочерним категориям).
- **Географический поиск**:
  - Поиск организаций в заданном радиусе от точки (с использованием формулы гаверсинусов).
  - Поиск организаций в заданном прямоугольнике по координатам.

API защищено авторизацией через API-ключ, который передается в заголовке `X-API-Key`.

## Стэк

- **FastAPI** — высокопроизводительный веб-фреймворк для создания API.
- **SQLAlchemy** — ORM для работы с базой данных.
- **PostgreSQL** — основная база данных (в тестах используется SQLite).
- **Alembic** — инструмент миграций базы данных.
- **Docker** — контейнеризация приложения и базы данных.
- **Poetry** — управление зависимостями Python.

## Структура проекта

```
MicrocreditCompanyNebusTest/
├── app/                    # Основной код приложения
│   ├── routers/           # Маршруты API (organizations, buildings, activities)
│   ├── crud.py            # Логика работы с данными
│   ├── database.py        # Настройка подключения к БД
│   ├── dependencies.py    # Зависимости (например, авторизация)
│   ├── main.py            # Точка входа в приложение
│   ├── models.py          # Модели SQLAlchemy
│   ├── schemas.py         # Схемы Pydantic для валидации
├── migrations/             # Миграции базы данных (Alembic)
├── tests/                  # Тесты приложения
├── docker-compose.yml      # Конфигурация Docker Compose
├── Dockerfile             # Конфигурация Docker для приложения
├── pyproject.toml         # Зависимости и настройки Poetry
├── seed.py                # Скрипт для заполнения базы тестовыми данными
├── README.md              # Документация проекта
```

## Установка и запуск

### Вариант 1: С использованием Docker

1. **Склонируйте репозиторий**:
   ```bash
   git clone https://github.com/SamBackWork/MicrocreditCompanyNebusTest.git
   ```
2. **Перейдите в директорию проекта**:
   ```bash
   cd MicrocreditCompanyNebusTest
   ```
3. **Соберите Docker-образы**:
   ```bash
   docker-compose build
   ```
4. **Запустите контейнеры**:
   ```bash
   docker-compose up
   ```
   Или для фонового режима:
   ```bash
   docker-compose up -d
   ```

Приложение будет доступно по адресу `http://localhost:8000`.  
Документация API (Swagger UI): `http://localhost:8000/docs`.  
Пароль для авторизации (API-ключ): `root`.

Для остановки контейнеров:
```bash
docker-compose down
```

### Вариант 2: Без Docker (локальная установка)

1. **Убедитесь, что у вас установлены зависимости**:
   - Python 3.13+
   - PostgreSQL (локально или на сервере)
   - Poetry (для управления зависимостями):  
     ```bash
     pip install poetry
     ```

2. **Склонируйте репозиторий**:
   ```bash
   git clone https://github.com/SamBackWork/MicrocreditCompanyNebusTest.git
   ```
3. **Перейдите в директорию проекта**:
   ```bash
   cd MicrocreditCompanyNebusTest
   ```
4. **Установите зависимости через Poetry**:
   ```bash
   poetry install
   ```
5. **Настройте переменные окружения**:
   Создайте файл `.env` в корне проекта и добавьте следующие переменные:
   ```
   DATABASE_URL=postgresql://postgres:root@localhost:5432/postgres
   API_KEY=root
   ```
   Замените параметры `DATABASE_URL` на свои (имя пользователя, пароль, хост, порт, имя базы данных).

6. **Создайте базу данных PostgreSQL**:
   Подключитесь к PostgreSQL и выполните:
   ```sql
   CREATE DATABASE postgres;
   ```

7. **Примените миграции базы данных**:
   ```bash
   poetry run alembic upgrade head
   ```
8. **(Опционально) Заполните базу тестовыми данными**:
   ```bash
   poetry run python seed.py
   ```
9. **Запустите приложение**:
   ```bash
   poetry run uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
   ```

Приложение будет доступно по адресу `http://localhost:8000`.  
Документация API (Swagger UI): `http://localhost:8000/docs`.

## Переменные окружения

- `DATABASE_URL` — строка подключения к базе данных PostgreSQL (например, `postgresql://user:password@host:port/dbname`).
- `API_KEY` — ключ для авторизации в API (по умолчанию `root`).

## Использование API

API предоставляет следующие основные эндпоинты (все требуют заголовок `X-API-Key`):

### Организации
- `GET /organizations/` — получить список организаций (с пагинацией: `skip`, `limit`).
- `GET /organizations/{organization_id}` — получить организацию по ID.
- `POST /organizations/` — создать новую организацию.
- `GET /organizations/by_building/{building_id}` — список организаций в здании.
- `GET /organizations/by_activity/{activity_id}` — список организаций по виду деятельности (параметр `recursive=true` для поиска по дочерним категориям).
- `GET /organizations/within_radius/` — организации в радиусе (`latitude`, `longitude`, `radius`).
- `GET /organizations/within_rectangle/` — организации в прямоугольнике (`lat_min`, `long_min`, `lat_max`, `long_max`).
- `GET /organizations/by_name/{name}` — поиск организаций по подстроке в имени.

### Здания
- `GET /buildings/` — список зданий (с пагинацией).
- `GET /buildings/{building_id}` — информация о здании по ID.
- `POST /buildings/` — создать новое здание.

### Виды деятельности
- `GET /activities/` — список видов деятельности (с пагинацией).
- `GET /activities/{activity_id}` — информация о виде деятельности по ID (включая дочерние).
- `POST /activities/` — создать новый вид деятельности.
- `GET /activities/by_name/{name}` — поиск видов деятельности по подстроке в имени.

Подробности запросов и схемы данных доступны в Swagger UI (`/docs`).

## Тестирование

Запустите тесты с помощью Poetry:
```bash
poetry run pytest
```

Тесты используют SQLite в памяти и покрывают основные операции CRUD для организаций, зданий и видов деятельности, а также географические запросы.

### Проверка через Swagger UI
1. Запустите приложение.
2. Перейдите по адресу `http://localhost:8000/docs`.
3. Авторизуйтесь, указав API-ключ (`root`) в поле авторизации.
4. Убедитесь, что:
   - Все маршруты (`/organizations`, `/buildings`, `/activities`) отображаются.
   - Для каждого маршрута доступны методы (GET, POST).
   - Параметры (path, query, body) видны и работают через "Try it out".

## Примечания
- Географический поиск использует формулу гаверсинусов для расчета расстояния в радиусе и простую фильтрацию координат для прямоугольника.
- Иерархия видов деятельности ограничена 3 уровнями вложенности (поиск с `recursive=true` учитывает это ограничение).
- Логирование запросов и ответов включено через middleware в `app/main.py`.
